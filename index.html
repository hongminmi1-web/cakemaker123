<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜œí™” 3D í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì¼€ì´í¬ ê¾¸ë¯¸ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

    <style>
        :root { --primary-color: #d32f2f; --classroom-bg: #e8f5e9; --button-color: #388e3c; --font-cute: 'Jua', sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: var(--font-cute); touch-action: none; background: var(--classroom-bg); }
        
        #game-container { display: flex; width: 100vw; height: 100vh; position: relative; visibility: hidden; }

        .screen { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            flex-direction: column; align-items: center; justify-content: center; 
            background: rgba(255,255,255,0.98); z-index: 1000; 
        }
        .active { display: flex; }

        #left-sidebar {
            width: 350px; height: 100%; background-color: #fffde7; border-right: 6px solid #c62828;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 25px; box-sizing: border-box; z-index: 10;
        }
        .notice-board { 
            background: white; padding: 30px; border-radius: 20px; border: 5px dashed #c62828; 
            box-shadow: 5px 5px 15px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box;
        }
        .notice-title { font-size: 32px; color: #c62828; margin-bottom: 25px; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; white-space: nowrap; }
        .notice-list { font-size: 24px; color: #333; line-height: 1.8; word-break: keep-all; padding: 0; margin: 0; list-style: none; }
        .notice-list li { margin-bottom: 15px; position: relative; padding-left: 10px; }
        .highlight-text { color: #d32f2f; font-weight: bold; }

        h1 { font-size: 75px; color: #c62828; margin-bottom: 40px; }
        #start-btn { padding: 30px 80px; font-size: 55px; cursor: pointer; background: var(--primary-color); color: white; border: none; border-radius: 30px; box-shadow: 0 10px 0 #8e0000; font-family: var(--font-cute); }
        #start-btn:active { transform: translateY(5px); box-shadow: none; }
        
        .cake-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .cake-option { width: 220px; height: 220px; background: white; border-radius: 25px; border: 6px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 26px; cursor: pointer; transition: 0.2s; }
        .cake-option span { font-size: 80px; }

        .top-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; z-index: 50; }
        .palette { background: white; padding: 12px 20px; border-radius: 40px; display: flex; gap: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); align-items: center; }
        .tool-btn { width: 75px; height: 75px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; border: 4px solid #eee; transition: 0.2s; background: #fff; }
        .tool-btn.selected { border-color: var(--primary-color); transform: scale(1.15); background: #fff5f5; z-index: 2; }
        .piping-bag-svg { width: 55px; height: 55px; }

        #music-toggle { width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 30px; border: 3px solid #eee; }
        
        #item-tray { width: 100%; height: 180px; background: rgba(255,255,255,0.95); display: flex; justify-content: space-evenly; align-items: center; position: absolute; bottom: 0; z-index: 40; border-top: 6px solid var(--primary-color); }
        .item { cursor: grab; display: flex; flex-direction: column; align-items: center; transition: 0.2s; }
        .item-icon { font-size: 70px; }

        #photo-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<audio id="bgm" loop preload="auto">
    <source src="https://www.chosic.com/wp-content/uploads/2021/11/We-Wish-You-A-Merry-Christmas-Instruments.mp3" type="audio/mpeg">
</audio>

<audio id="success-sound" preload="auto">
    <source src="https://www.soundjay.com/human/applause-01.mp3" type="audio/mpeg">
</audio>

<div id="game-container">
    <div id="left-sidebar">
        <div class="notice-board">
            <div class="notice-title">ğŸ… ê¾¸ë¯¸ê¸° ë°©ë²•</div>
            <ul class="notice-list">
                <li>1. ì¥ì‹ë¬¼ì„ <span class="highlight-text">ë“œë˜ê·¸</span> í•´ì„œ ì˜¬ë¦¬ê±°ë‚˜, ì§¤ì£¼ë¨¸ë‹ˆë¡œ ê¾¸ë©°ë³´ì„¸ìš”!</li>
                <li>2. ì§¤ì£¼ë¨¸ë‹ˆ ì‚¬ìš© í›„ <span style="font-size:30px;">âœ‹</span> ì„ ëˆŒëŸ¬ì•¼ <span class="highlight-text">ì¥ì‹ë¬¼ ê¾¸ë¯¸ê¸°</span>ê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.</li>
                <li>3. ì¼€ì´í¬ë¥¼ <span class="highlight-text">ì´ë¦¬ ì €ë¦¬ ëŒë ¤ì„œ</span> ê¾¸ë©°ë³´ì„¸ìš”.</li>
            </ul>
        </div>
    </div>

    <div id="main-content" style="flex:1; position:relative;">
        <div id="canvas-container" style="width:100%; height:100%;"></div>
        
        <div class="top-controls">
            <div id="music-toggle" onclick="toggleMusic()">ğŸµ</div>
            <div class="palette">
                <div class="tool-btn" onclick="setDrawTool('#d32f2f', this)"><svg class="piping-bag-svg" viewBox="0 0 100 100"><path fill="#d32f2f" d="M20,80 L40,95 L60,95 L80,80 L50,10 Z"/><circle fill="#fff" cx="50" cy="85" r="5"/></svg></div>
                <div class="tool-btn" onclick="setDrawTool('#1976d2', this)"><svg class="piping-bag-svg" viewBox="0 0 100 100"><path fill="#1976d2" d="M20,80 L40,95 L60,95 L80,80 L50,10 Z"/><circle fill="#fff" cx="50" cy="85" r="5"/></svg></div>
                <div class="tool-btn" onclick="setDrawTool('#fbc02d', this)"><svg class="piping-bag-svg" viewBox="0 0 100 100"><path fill="#fbc02d" d="M20,80 L40,95 L60,95 L80,80 L50,10 Z"/><circle fill="#fff" cx="50" cy="85" r="5"/></svg></div>
                <div class="tool-btn" onclick="setDrawTool('#333', this)"><svg class="piping-bag-svg" viewBox="0 0 100 100"><path fill="#333" d="M20,80 L40,95 L60,95 L80,80 L50,10 Z"/><circle fill="#fff" cx="50" cy="85" r="5"/></svg></div>
                <div class="tool-btn" onclick="setDrawTool('#fff', this)"><svg class="piping-bag-svg" viewBox="0 0 100 100"><path fill="#fff" stroke="#ccc" stroke-width="2" d="M20,80 L40,95 L60,95 L80,80 L50,10 Z"/><circle fill="#ccc" cx="50" cy="85" r="5"/></svg></div>
                <div class="tool-btn selected" onclick="setDrawTool(null, this)" style="font-size:35px;">âœ‹</div>
            </div>
            <button id="finish-btn" onclick="finishGame()" style="padding:15px 30px; font-size:25px; background:#388e3c; color:white; border:none; border-radius:15px; cursor:pointer; font-family:'Jua'; box-shadow: 0 6px 0 #1b5e20;">âœ¨ ì™„ì„±!</button>
        </div>

        <div id="item-tray">
            <div class="item" draggable="true" ondragstart="drag(event)" data-emoji="ğŸ„"><div class="item-icon">ğŸ„</div></div>
            <div class="item" draggable="true" ondragstart="drag(event)" data-emoji="ğŸ…"><div class="item-icon">ğŸ…</div></div>
            <div class="item" draggable="true" ondragstart="drag(event)" data-emoji="ğŸ¦Œ"><div class="item-icon">ğŸ¦Œ</div></div>
            <div class="item" draggable="true" ondragstart="drag(event)" data-emoji="â›„"><div class="item-icon">â›„</div></div>
            <div class="item" draggable="true" ondragstart="drag(event)" data-emoji="ğŸ"><div class="item-icon">ğŸ</div></div>
            <div class="item" draggable="true" ondragstart="drag(event)" data-emoji="â„ï¸"><div class="item-icon">â„ï¸</div></div>
            <div class="item" draggable="true" ondragstart="drag(event)" data-emoji="ğŸ””"><div class="item-icon">ğŸ””</div></div>
            <div class="item" draggable="true" ondragstart="drag(event)" data-emoji="ğŸ€"><div class="item-icon">ğŸ€</div></div>
            <div class="item" draggable="true" ondragstart="drag(event)" data-emoji="ğŸ­"><div class="item-icon">ğŸ­</div></div>
            <div class="item" draggable="true" ondragstart="drag(event)" data-emoji="ğŸª"><div class="item-icon">ğŸª</div></div>
        </div>
    </div>
</div>

<div id="screen-start" class="screen active">
    <h1>ğŸ„ í˜œí™” í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì¼€ì´í¬</h1>
    <button id="start-btn" onclick="startExperience()">ì‹œì‘í•˜ê¸°!</button>
</div>

<div id="screen-select" class="screen">
    <h2 style="font-size: 45px; color: #c62828; margin-bottom:30px;">ì–´ë–¤ ë¹µìœ¼ë¡œ ë§Œë“¤ê¹Œìš”?</h2>
    <div class="cake-grid">
        <div class="cake-option" onclick="selectCake(0xFFFDD0)"><span>ğŸ‚</span>ìƒí¬ë¦¼</div>
        <div class="cake-option" onclick="selectCake(0x5D4037)"><span>ğŸ«</span>ì´ˆì½”</div>
        <div class="cake-option" onclick="selectCake(0x6B8E23)"><span>ğŸ„</span>ë…¹ì°¨</div>
        <div class="cake-option" onclick="selectCake(0xE67E22)"><span>ğŸ…</span>ë ˆë“œë²¨ë²³</div>
    </div>
</div>

<div id="photo-popup">
    <div style="background:white; padding:30px; border-radius:20px; text-align:center; max-width:80%;">
        <img id="captured-image" style="max-width:100%; border-radius:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <h2 style="font-size:35px; color:#c62828; margin-top:20px;">ğŸ„ ì •ë§ ë©‹ì§„ ì¼€ì´í¬ë„¤ìš”! ğŸ„</h2>
        <button onclick="location.reload()" style="padding:15px 40px; font-size:25px; background:#d32f2f; color:white; border:none; border-radius:15px; cursor:pointer; font-family:'Jua'; box-shadow:0 6px 0 #8e0000;">ë‹¤ì‹œ ë§Œë“¤ê¸°</button>
    </div>
</div>

<script>
    let scene, camera, renderer, cakeMesh, controls, audioCtx;
    let draggedEmoji = null;
    let isDrawing = false;
    let drawColor = null;
    let pointerDown = false;
    const bgm = document.getElementById('bgm');
    const successSound = document.getElementById('success-sound');

    // [ì†Œë¦¬ ì¬ìƒ ì•ˆì •í™”] ì†Œë¦¬ ì ê¸ˆ í•´ì œ í•¨ìˆ˜
    function unlockAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playDing() {
        unlockAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1320, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.4);
    }

    function startExperience() {
        unlockAudio();
        // ë°°ê²½ìŒì•… ê°•ì œ ì¬ìƒ ì‹œë„
        bgm.volume = 0.2;
        const playBgm = () => {
            bgm.play().then(() => {
                document.getElementById('music-toggle').innerText = 'ğŸµ';
            }).catch(() => {
                console.log("ì¬ì‹œë„ ì¤‘...");
                setTimeout(playBgm, 500); // ì‹¤íŒ¨ ì‹œ 0.5ì´ˆ í›„ ì¬ì‹œë„
            });
        };
        playBgm();
        goToStep(2);
    }

    function toggleMusic() {
        unlockAudio();
        if (bgm.paused) { bgm.play(); document.getElementById('music-toggle').innerText = 'ğŸµ'; }
        else { bgm.pause(); document.getElementById('music-toggle').innerText = 'ğŸ”‡'; }
    }

    function goToStep(step) {
        document.getElementById('screen-start').classList.remove('active');
        document.getElementById('screen-select').classList.remove('active');
        if (step === 2) document.getElementById('screen-select').classList.add('active');
        else if (step === 3) document.getElementById('game-container').style.visibility = 'visible';
    }

    function selectCake(color) {
        goToStep(3);
        if (!scene) { setTimeout(() => { init3D(); createCake(color); }, 50); }
        else { createCake(color); }
    }

    function init3D() {
        const container = document.getElementById('canvas-container');
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 30, 50);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const light = new THREE.DirectionalLight(0xffffff, 0.5);
        light.position.set(10, 40, 20);
        scene.add(light);
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.enableZoom = false;
        renderer.domElement.addEventListener('dragover', e => e.preventDefault());
        renderer.domElement.addEventListener('drop', handleDrop);
        const start = (e) => { pointerDown = true; if(isDrawing) handleInput(e); };
        const move = (e) => { if(pointerDown && isDrawing) handleInput(e); };
        const end = () => { pointerDown = false; };
        renderer.domElement.addEventListener('mousedown', start);
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', end);
        renderer.domElement.addEventListener('touchstart', (e) => start(e.touches[0]), {passive:false});
        renderer.domElement.addEventListener('touchmove', (e) => { e.preventDefault(); move(e.touches[0]); }, {passive:false});
        renderer.domElement.addEventListener('touchend', end);
        animate();
    }

    function createCake(color) {
        if(cakeMesh) scene.remove(cakeMesh);
        cakeMesh = new THREE.Mesh(new THREE.CylinderGeometry(15, 15, 12, 64), new THREE.MeshStandardMaterial({ color: color, roughness: 0.8 }));
        scene.add(cakeMesh);
        const plate = new THREE.Mesh(new THREE.CylinderGeometry(18, 18, 1, 64), new THREE.MeshStandardMaterial({color:0xffffff}));
        plate.position.y = -6.5;
        scene.add(plate);
    }

    function setDrawTool(color, btn) {
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        drawColor = color;
        isDrawing = !!color;
        controls.enabled = !isDrawing;
    }

    function handleInput(e) {
        const container = document.getElementById('canvas-container');
        const rect = container.getBoundingClientRect();
        const mouse = new THREE.Vector2(((e.clientX - rect.left) / rect.width) * 2 - 1, -((e.clientY - rect.top) / rect.height) * 2 + 1);
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        const hits = raycaster.intersectObject(cakeMesh);
        if(hits.length > 0) {
            const dot = new THREE.Mesh(new THREE.SphereGeometry(0.5, 8, 8), new THREE.MeshStandardMaterial({ color: drawColor }));
            dot.position.copy(hits[0].point).add(hits[0].face.normal.multiplyScalar(0.2));
            scene.add(dot);
        }
    }

    function drag(e) { draggedEmoji = e.target.closest('.item').dataset.emoji; }
    function handleDrop(e) {
        e.preventDefault(); if (isDrawing) return;
        const container = document.getElementById('canvas-container');
        const rect = container.getBoundingClientRect();
        const mouse = new THREE.Vector2(((e.clientX - rect.left) / rect.width) * 2 - 1, -((e.clientY - rect.top) / rect.height) * 2 + 1);
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        const hits = raycaster.intersectObject(cakeMesh);
        if(hits.length > 0) {
            const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d'); ctx.font = '100px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(draggedEmoji, 64, 64);
            const item = new THREE.Mesh(new THREE.PlaneGeometry(8, 8), new THREE.MeshStandardMaterial({ map: new THREE.CanvasTexture(canvas), transparent: true, alphaTest: 0.5 }));
            item.position.copy(hits[0].point).add(hits[0].face.normal.multiplyScalar(1.5));
            item.lookAt(hits[0].point.clone().add(hits[0].face.normal));
            scene.add(item);
            playDing();
        }
    }

    function animate() { requestAnimationFrame(animate); if(controls) controls.update(); if(renderer) renderer.render(scene, camera); }

    function finishGame() {
        unlockAudio();
        // í­ì£½ íš¨ê³¼
        const duration = 5 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 3000 };
        const randomInRange = (min, max) => Math.random() * (max - min) + min;

        const interval = setInterval(function() {
            const timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);
            const particleCount = 50 * (timeLeft / duration);
            confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
            confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
        }, 250);

        // í™˜í˜¸ì„± ì†Œë¦¬ ì¬ìƒ (ì•ˆì •ì ì¸ ë§í¬ë¡œ êµì²´)
        successSound.currentTime = 0;
        successSound.volume = 0.8;
        successSound.play().catch(() => {
            console.log("í™˜í˜¸ì„± ì¬ìƒ ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘...");
            setTimeout(() => successSound.play(), 500);
        });

        setTimeout(() => {
            const imgData = renderer.domElement.toDataURL("image/png");
            document.getElementById('captured-image').src = imgData;
            document.getElementById('photo-popup').style.display = 'flex';
        }, 800);
    }

    window.addEventListener('resize', () => {
        const container = document.getElementById('canvas-container');
        if(!renderer) return;
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    });
</script>
</body>
</html>
